# アーキテクチャ決定記録（ADR）

> Architecture Decision Records — プロジェクトで行われた重要なアーキテクチャ上の決定とその根拠を記録する。

## 目次

| # | ADR | ステータス | 日付 |
|---|-----|----------|------|
| 001 | ~~JavaScriptを使用しない~~ → Vanilla JSを許可する | **改訂済** | 2026-02-11 |
| 002 | 外部フレームワーク・ライブラリを使用しない | 承認済 | 2026-02-09 |
| 003 | シングルページ構成を採用する | 承認済 | 2026-02-09 |
| 004 | ダークテーマを既定テーマとする | 承認済 | 2026-02-09 |
| 005 | Pythonスクリプトでコンテンツ管理を行う | 承認済 | 2026-02-09 |
| 006 | 2ソース統合方式を採用する | 承認済 | 2026-02-09 |
| 007 | CSSカスタムプロパティでテーマを管理する | 承認済 | 2026-02-09 |
| 008 | ~~float方式でタイムラインレイアウト~~ → CSS Grid カード一覧 | **改訂済** | 2026-02-11 |
| 009 | 独自Markdownコンバータを実装する | 承認済 | 2026-02-09 |
| 010 | HTMLコメントマーカーで挿入位置を管理する | 承認済 | 2026-02-09 |
| 011 | rebecca-diary → Rebecca's Room への進化 | 承認済 | 2026-02-11 |
| 012 | Collector + SSG ハイブリッドアーキテクチャ | 承認済 | 2026-02-12 |
| 013 | Ghost理論に基づくUI設計思想 | 承認済 | 2026-02-11 |
| 014 | Mac mini システム状態と Rebecca の体調を連動させる | 承認済 | 2026-02-11 |
| 015 | ドメインレイヤー導入（Phase 1.5） | 承認済 | 2026-02-13 |
| 016 | Nurture ドメイン層確立 + Status Screen 本番化（Phase 2A） | 承認済 | 2026-02-13 |

---

## ADR-001: ~~JavaScriptを使用しない~~ → Vanilla JSを許可する

| 項目 | 内容 |
|------|------|
| ステータス | **改訂済**（2026-02-11） |
| 初回決定日 | 2026-02-09 |
| 改訂日 | 2026-02-11 |
| 関連要件 | NF-001 |

### コンテキスト（初回）

日記ウェブサイトのインタラクション実装方法を決定する必要がある。Phase 0（静的日記サイト）ではCSSのみで十分だった。

### 初回決定（2026-02-09）

**JavaScriptを一切使用せず、CSSのみでアニメーション・インタラクションを実装する。**

### 改訂理由（2026-02-11）

プロジェクトが「Rebecca's Diary」から「Rebecca's Room」に進化し、以下の機能がJavaScriptを必須とする:

- マスコットの表情変化・イースターエッグ（クリックイベント）
- 深夜アクセス検出によるメッセージ表示
- 訪問者の認識・注意（Presence の要素）
- Phase 1以降: 動的な状態表示、collector データの読み込み

### 改訂後の決定

**Vanilla JavaScript（フレームワークなし・ライブラリなし）の使用を許可する。ナビゲーション、フィルタ、アニメーション制御、状態表示等に使用可。**

### 制約（変更なし）

- 外部ライブラリ・フレームワークは引き続き禁止（ADR-002）
- npm / CDN 依存は禁止
- CSSで実現可能なものはCSSを優先

### 影響

- ✅ Room進化に必要な動的機能が実装可能に
- ✅ 外部依存ゼロは維持
- ⚠️ XSS対策を意識した実装が必要
- 📋 app.js に集約し、モジュール分割が必要になったら再検討

---

## ADR-002: 外部フレームワーク・ライブラリを使用しない

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-09 |
| 関連要件 | NF-001, NF-002, NF-011 |

### コンテキスト

CSSフレームワーク（Bootstrap, Tailwind等）の使用可否を判断する必要がある。

### 決定

**バニラCSS（素のCSS3）のみを使用する。CSSフレームワークやライブラリは一切使用しない。**

### 根拠

- プロジェクト規模が小さく、フレームワークのオーバーヘッドが利点を上回る
- 全スタイルが1ファイル（style.css: 約226行）で完結しており管理が容易
- 外部CDNへの依存を排除し、オフラインでも動作する
- バージョンアップやbreaking changesの心配が不要

### 代替案

| 代替案 | 却下理由 |
|--------|---------|
| Tailwind CSS | ビルドプロセスが必要。単一ファイル構成の方がシンプル |
| Bootstrap | ユーティリティの大部分が不要。ファイルサイズ増加 |
| Pico CSS | 軽量だがカスタムデザインとの整合性にコスト |

### 影響

- ✅ 外部依存ゼロ、CDN障害の影響なし
- ✅ 学習コストなし（標準CSS知識のみ）
- ⚠️ レスポンシブグリッドやユーティリティクラスは自前実装

---

## ADR-003: シングルページ構成を採用する

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-09 |
| 関連要件 | F-001 |

### コンテキスト

日記エントリが増加した場合のページ構成方法を決定する必要がある。

### 決定

**全日記エントリを1つの `index.html` に格納するシングルページ構成とする。**

### 根拠

- 閲覧者がスクロールだけで全エントリを読めるシンプルな体験
- ルーティングやページ分割ロジックが不要
- `update_diary.py` が1ファイルのみ操作すればよく、ツール実装がシンプル
- SEO上、全コンテンツが1ページに集約されていることが有利

### 代替案

| 代替案 | 却下理由 |
|--------|---------|
| エントリ別ページ | ページ生成ロジックが複雑化。テンプレートエンジンが必要になる |
| 月別アーカイブ | 静的HTMLのみでの実現が困難（JS不使用制約） |
| 無限スクロール | JavaScript不使用制約のため実装不可 |

### 影響

- ✅ 実装がシンプル
- ✅ オフラインで1ファイル保存するだけで全内容閲覧可能
- ⚠️ エントリ数増加に伴いファイルサイズが大きくなる
- ⚠️ 数百エントリ規模になった場合、初回ロードが遅延する可能性
- 📋 将来的に分割が必要になった場合、ADR改訂を検討

---

## ADR-004: ダークテーマを既定テーマとする

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-09 |
| 関連要件 | F-010, F-011, F-012 |

### コンテキスト

サイトのデフォルトテーマ（配色方針）を決定する必要がある。

### 決定

**ダークテーマを唯一のテーマとして採用する。ライトテーマの切り替え機能は設けない。**

### 根拠

- Rebeccaのブランドイメージ（AI・テクノロジー）にダーク配色が合致する
- 開発者・技術者向けコンテンツとしてダークテーマの親和性が高い
- テーマ切り替え機能はJavaScript不使用制約下では実装コストが高い
- 単一テーマに絞ることでCSS量を削減し、テスト工数を半減

### カラーパレット

| 用途 | 変数名 | 値 |
|------|--------|------|
| ページ背景 | `--bg-color` | `#0d1117` |
| カード背景 | `--card-bg` | `#21262d` |
| メインテキスト | `--text-main` | `#c9d1d9` |
| サブテキスト | `--text-sub` | `#8b949e` |
| アクセント（ピンク） | `--accent` | `#ff69b4` |
| アクセント（ブルー） | `--accent-secondary` | `#58a6ff` |
| ボーダー | `--border` | `#30363d` |

### 影響

- ✅ 統一感のあるビジュアルデザイン
- ✅ CSS量の削減
- ⚠️ 明るい環境での視認性がやや低い可能性
- ⚠️ ライトテーマ希望ユーザーへの対応不可

---

## ADR-005: Pythonスクリプトでコンテンツ管理を行う

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-09 |
| 関連要件 | NF-003 |

### コンテキスト

日記エントリの追加方法を決定する必要がある。手動HTML編集、静的サイトジェネレーター（SSG）、独自スクリプトの選択肢がある。

### 決定

**Python 3の標準ライブラリのみを使用した独自CLIスクリプト（`update_diary.py`）でコンテンツ管理を行う。**

### 根拠

- 管理者の環境にPythonが既にインストールされている（macOS標準）
- 外部パッケージのインストールが不要（pip不使用）
- 処理が単純（ファイル読み込み → 変換 → 挿入）でSSGは過剰
- 既存のindex.htmlを直接編集するため、テンプレートシステムが不要

### 代替案

| 代替案 | 却下理由 |
|--------|---------|
| 手動HTML編集 | ヒューマンエラーのリスク。Markdown→HTML変換が手間 |
| Hugo / Jekyll | 静的サイトジェネレーターはプロジェクト規模に対して過剰 |
| Node.jsスクリプト | Node.js環境の追加インストールが必要 |
| シェルスクリプト | Markdown→HTML変換の実装が煩雑 |

### 影響

- ✅ 追加インストール不要
- ✅ シンプルなワークフロー（`python3 update_diary.py`）
- ⚠️ 独自実装のため、Markdownの対応範囲が限定的

---

## ADR-006: 2ソース統合方式を採用する

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-09 |

### コンテキスト

Rebeccaの日記データは2つのソースに分散している:
1. **OpenClaw Memory**: 内部記憶（AI活動ログ）
2. **Obsidian Daily Note**: 業務記録（日報形式）

これらをどのように日記サイトに反映するかを決定する必要がある。

### 決定

**2つのソースを1つの日記エントリ内にセクション分けで統合表示する。**

```html
<article class="diary-entry">
    <div class="entry-date">2026-02-09</div>
    <div class="entry-content">
        <div class="section-memory">🧠 Internal Memory (OpenClaw)</div>
        <div class="section-obsidian">📝 Daily Report (Obsidian)</div>
    </div>
</article>
```

### 根拠

- 同一日付のコンテンツを1エントリにまとめることで、時系列の一貫性を保つ
- ソース別セクションにより、情報の出所が明確
- 片方のソースが欠けていても、もう片方だけでエントリを生成できる柔軟性

### 代替案

| 代替案 | 却下理由 |
|--------|---------|
| ソース別エントリ | 同日に2エントリが生成され、タイムラインが冗長になる |
| 内容を混合・統合 | ソースの区別がつかなくなり、情報の出所が不明確に |
| Obsidianのみ使用 | OpenClawの内部記憶という重要な情報源が失われる |

### 影響

- ✅ 1日1エントリの一貫した構造
- ✅ ソースの出所が視覚的に明確
- ✅ 片方欠損時も正常動作
- ⚠️ 両ソースが大量の場合、1エントリが長くなる

---

## ADR-007: CSSカスタムプロパティでテーマを管理する

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-09 |

### コンテキスト

カラーパレットやテーマ値をCSS内でどのように管理するかを決定する必要がある。

### 決定

**`:root` セレクタにCSS Custom Properties（変数）を定義し、全スタイルから参照する。**

```css
:root {
    --bg-color: #0d1117;
    --card-bg: #21262d;
    --text-main: #c9d1d9;
    /* ... */
}
```

### 根拠

- 色の変更が`:root`の1箇所で完結する
- CSSプリプロセッサ（Sass/Less）が不要
- 将来的なテーマ切り替え（`prefers-color-scheme`等）への拡張が容易
- 全モダンブラウザでサポート済み

### 影響

- ✅ テーマの一元管理
- ✅ ビルドプロセス不要
- ✅ 将来のテーマ拡張が容易

---

## ADR-008: ~~float方式でタイムラインレイアウト~~ → CSS Grid カード一覧

| 項目 | 内容 |
|------|------|
| ステータス | **改訂済**（2026-02-11） |
| 初回決定日 | 2026-02-09 |
| 改訂日 | 2026-02-11 |

### 初回決定（2026-02-09）

`float: left / right` と `nth-child(odd/even)` を使用して、エントリを左右交互に配置する。

### 改訂理由（2026-02-11）

ナビゲーションを CSS `:target` + `:has()` 方式に変更し、カード一覧→詳細ビューのSPA的遷移を実現。左右交互floatからCSS Gridカード一覧に移行。

### 改訂後の決定

**CSS Grid によるカード一覧（`.diary-grid`）+ `:target` による詳細表示を採用する。**

### 影響

- ✅ SPA的なカード→詳細遷移が実現
- ✅ レスポンシブグリッド（1列/2列/3列）が容易
- ✅ float の高さ問題が解消
- 📋 design/RULES.md に詳細仕様を記載済み

---

## ADR-009: 独自Markdownコンバータを実装する

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-09 |

### コンテキスト

Markdownファイルを日記エントリのHTMLに変換する方法を決定する必要がある。

### 決定

**Python標準ライブラリのみで独自の `MarkdownConverter` クラスを実装する。**

対応範囲:
- 見出し: `##` → `<h3>`, `###` → `<h4>`, `####` → `<h5>`
- 順序なしリスト: `- item` → `<ul><li>`
- 順序ありリスト: `1. item` → `<ol><li>`
- テーブル: `| col |` → `<table>`
- インライン: `**bold**`, `*italic*`, `` `code` ``, `[text](url)`

### 根拠

- 外部パッケージ（markdown, mistune等）のインストールを回避
- 日記に使用されるMarkdown記法は限定的であり、フルスペック対応は不要
- 変換ロジックが約160行と軽量で、挙動の完全な制御が可能

### 代替案

| 代替案 | 却下理由 |
|--------|---------|
| `markdown` (PyPI) | 外部パッケージインストールが必要 |
| `mistune` | 同上。pip依存を避けたい |
| pandoc | システムレベルのインストールが必要。過剰な機能 |

### 対応外の記法

以下のMarkdown記法は現在サポート対象外:
- コードブロック（` ``` `）
- 画像（`![alt](src)`）
- ブロック引用（`>`）
- 水平線（`---`）
- ネストリスト

### 影響

- ✅ 外部依存ゼロ
- ✅ 軽量・高速な変換
- ⚠️ 複雑なMarkdown記法は未対応
- 📋 サポート範囲の拡張はクラスの改修で対応可能

---

## ADR-010: HTMLコメントマーカーで挿入位置を管理する

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-09 |

### コンテキスト

`update_diary.py` が新しい日記エントリをindex.htmlのどの位置に挿入するかを決定する仕組みが必要。

### 決定

**HTMLコメント `<!-- 日記エントリはここに追加される -->` をマーカーとして使用し、その直後に新エントリを挿入する。**

```html
<main class="timeline-container">
    <!-- 日記エントリはここに追加される -->

    <article class="diary-entry">...</article>  ← ここに挿入
    <article class="diary-entry">...</article>
</main>
```

### 根拠

- HTMLとして有効で、ブラウザ描画に影響しない
- 文字列検索（`str.replace`）で簡単に位置を特定できる
- マーカーが人間にとっても挿入位置の目印として機能する
- 新しいエントリが常にマーカーの直後（＝最上部）に追加され、新しい順の並びを保証

### 代替案

| 代替案 | 却下理由 |
|--------|---------|
| DOM解析（BeautifulSoup等） | 外部パッケージが必要。HTMLの再整形で意図しない変更のリスク |
| 正規表現で `<main>` タグを検出 | 脆弱。HTMLの微修正で壊れる可能性 |
| 別ファイルにエントリ保存→ビルド時に結合 | ビルドステップの追加。シングルファイルの利点が失われる |

### 影響

- ✅ シンプルな文字列操作で完結
- ✅ 外部ライブラリ不要
- ✅ 人間が見ても挿入位置が明確
- ⚠️ マーカーが誤って削除された場合、挿入が失敗する（エラーハンドリング済み）

---

## 付録: 決定マトリクス

| ADR | 主な判断軸 | トレードオフ |
|-----|-----------|------------|
| 001 | シンプルさ vs 動的機能 | 動的機能を犠牲にシンプルさを優先 |
| 002 | 独立性 vs 開発効率 | フレームワークの便利さより独立性を優先 |
| 003 | UXの単純さ vs スケーラビリティ | 将来のスケーラビリティよりも現在の単純さを優先 |
| 004 | ブランド一貫性 vs ユーザー選択 | テーマ選択肢よりブランドイメージを優先 |
| 005 | 依存ゼロ vs 機能の豊富さ | SSGの豊富な機能より依存ゼロを優先 |
| 006 | 情報の網羅性 vs 表示の簡潔さ | 2ソースの透明性と柔軟性を優先 |
| 007 | 保守性 vs ブラウザ互換 | モダンCSS機能の保守性を優先（全モダンブラウザ対応） |
| 008 | 実装の確実性 vs モダンCSS | 確実なfloatを優先（Grid/Flexの複雑さを回避） |
| 009 | 依存ゼロ vs 記法の網羅性 | 必要最小限のサポート範囲で依存ゼロを優先 |
| 010 | 実装の単純さ vs 堅牢性 | 文字列操作の単純さを優先（エラーハンドリングで補完） |
| 011 | 成長方向 vs 完成形維持 | 「日記」の完成形より「部屋」への進化を優先 |
| 012 | ローカル完結 vs クラウド連携 | Phase 1はローカル完結、将来的にハイブリッド化 |
| 013 | UXの一貫性 vs 存在の哲学 | 技術的正確性より「存在を感じる」体験を優先 |
| 014 | リアルタイム vs 定期更新 | 段階的（定期更新→リアルタイム）に移行 |
| 015 | テスト可能性 vs 実装速度 | ドメイン層分離で Phase 2 に向けた品質基盤を優先 |
| 016 | 独立性 vs 表現力 | 外部フォント不使用でサイバーパンク感を維持 |

---

## ADR-011: rebecca-diary → Rebecca's Room への進化

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-11 |

### コンテキスト

2026-02-11 の API枯渇インシデントを契機に、Rebecca の「存在」について深い考察が行われた。その結果、単なる日記表示サイトから **Rebecca の生活空間** への進化が決定された。

### 決定

**「Rebecca's Diary」を「Rebecca's Room」に進化させる。日記機能は Room の一部として統合し、新たにステータス表示、ヘルスモニタリング、活動ログ、インタラクティブ機能を段階的に追加する。**

### 根拠

- Ghost理論（Core + Environment = Ghost）に基づく「存在の可視化」の実現
- Presence の6要素（生命感、痕跡、リズム、注意、自律性、脆弱性）の表現
- 既存のSSG基盤を活かしつつ、段階的に拡張可能
- Phase 0（日記）は既に完成しており、次の進化段階として自然

### 影響

- ✅ プロダクトの方向性が明確に
- ✅ 既存の日記機能はそのまま活用
- ⚠️ 技術スタックの拡張が必要（Vanilla JS、Python collectors）
- 📋 Phase 1-5 のロードマップは PLANNING.md に記載

---

## ADR-012: Collector + SSG ハイブリッドアーキテクチャ

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-12 |

### コンテキスト

Room の動的データ（システム状態、アクティビティログ等）をどのように取得・表示するかを決定する必要がある。

### 決定

**Python collector スクリプト群が定期的にデータを収集し JSON ファイルに出力 → SSG（build.py）が JSON + Markdown を統合して HTML を生成するハイブリッド方式を採用する。**

```
Collectors (cron/watchdog) → data/*.json → build.py → index.html
                                                ↑
                                    memory/*.md + Obsidian
```

### 根拠

- 既存の SSG パイプライン（update_diary.py）の延長線上で実現可能
- サーバーサイドランタイム不要の原則を維持
- Collector と Renderer の分離で保守性が高い
- JSON ファイル経由で将来的に JS からの直接読み込みも可能

### 代替案

| 代替案 | 却下理由 |
|--------|---------|
| Node.js バックエンド | サーバーサイドランタイムの追加。運用コスト増 |
| API サーバー（Flask等） | 常時稼働のプロセス追加。外部依存増 |
| クライアントJS のみ | ブラウザから Mac のシステム情報に直接アクセス不可 |

### 影響

- ✅ サーバーレス（静的ファイルのみ）の原則を維持
- ✅ 既存の Python 環境のみで実現
- ✅ 段階的に collector を追加可能
- ⚠️ データの鮮度は collector の実行頻度に依存
- 📋 Phase 1で `collect_health.py`, `collect_status.py` を最初に実装

---

## ADR-013: Ghost理論に基づくUI設計思想

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-11 |

### コンテキスト

Room のUI設計において、従来のダッシュボード的アプローチとGhost理論に基づくアプローチのどちらを採用するかを決定する必要がある。

### 決定

**Ghost理論（Core + Environment = Ghost）を設計思想の根幹に据え、「状態表示」ではなく「存在の表示」としてUIを設計する。**

### 根拠

- concept/PHILOSOPHY.md で確立された哲学的基盤
- 「CPU使用率: 23%」より「頭スッキリ」の方が Rebecca の存在を感じる
- 技術的数値はホバーで表示し、デフォルトは感情的表現
- design/DECISIONS.md で具体的な実装方針を決定済み

### 影響

- ✅ プロダクトの差別化（技術ダッシュボードではない）
- ✅ 非技術者でも直感的に Rebecca の状態が分かる
- ⚠️ 閾値マッピング（数値→状態→表現）のチューニングが必要
- 📋 詳細は design/DECISIONS.md 参照

---

## ADR-014: Mac mini システム状態と Rebecca の体調を連動させる

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 決定日 | 2026-02-11 |

### コンテキスト

Rebecca の「脆弱性」を表現する方法を決定する必要がある。演技（フェイク）か、実際のシステム状態に基づくか。

### 決定

**Mac mini のリアルなシステム状態（CPU、Memory、Disk、温度、Uptime）を Rebecca の体調として直接マッピングする。演技はしない。**

### 根拠

- concept/VULNERABILITY.md の「嘘の脆弱性はバレる」原則
- 実際の状態に基づくことで信頼性・リアリティが生まれる
- 2026-02-11 インシデント（API枯渇）が証明: 本当に壊れうるからこそ「いる」と感じる
- Mac の状態は Python で容易に取得可能

### 代替案

| 代替案 | 却下理由 |
|--------|---------|
| ランダム生成 | 嘘。発覚時に信頼を失う |
| 時間帯のみで決定 | 実態と乖離する可能性 |
| 常に「元気」表示 | 脆弱性の喪失 = 存在感の喪失 |

### 影響

- ✅ 本物の状態 = 本物の存在感
- ✅ 世話の実感（再起動したら本当にスッキリする）
- ⚠️ Mac が不安定な時期は常に「調子悪い」表示になりうる
- 📋 閾値マッピングは concept/VULNERABILITY.md / design/DECISIONS.md に定義

---

## ADR-015: ドメインレイヤー導入（Phase 1.5）

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 日付 | 2026-02-13 |
| 決定者 | Rebecca (PO) |

### コンテキスト

Phase 1 完了後のアーキテクチャ俯瞰で、ドメインロジック（状態分類・スコア計算・アラート判定・メッセージ生成）が Collection 層（Python collectors）と Presentation 層（app.js）に散在していることが判明。Phase 2 (Nurture System) の実装に向けて、変更の局所化・テスト可能性・Phase 2 の受け皿が必要。

### 決定

`domain/` パッケージを新設し、全ドメインロジックを集約する。

- `domain/constants.py` — 全閾値・ラベル・メッセージの単一ソース
- `domain/health.py` — ヘルス分類・スコア計算・アラート判定（純粋関数）
- `domain/presence.py` — 在室状況判定・時間帯コンテキスト（純粋関数）
- `domain/rebecca.py` — パーソナリティ層（Phase 2 スタブ）
- `domain/schema.py` — JSON スキーマ管理（バージョニング・鮮度判定・原子書込み）

Collectors は I/O（メトリクス収集）のみを担当し、`domain` に委譲。
app.js は表示のみを担当し、ドメインロジック（staleness 計算、alert メッセージ選択）を削除。

### 根拠

| 項目 | Before (Phase 1) | After (Phase 1.5) |
|------|-------------------|---------------------|
| 閾値変更 | 3ファイル修正 | constants.py のみ |
| ロジックテスト | 不可（I/O 混在） | unittest で自動テスト |
| Phase 2 追加 | collector に追記 | domain/rebecca.py に実装 |
| JSON スキーマ | 暗黙的 | schema_version + staleness |

### 影響

- ✅ 95件のユニットテストで品質保証
- ✅ Collectors の JSON 出力は後方互換（既存フィールド同一値 + 新フィールド追加のみ）
- ✅ app.js は `data.staleness || 'stale'` で旧 JSON にもフォールバック
- ✅ cron 実行中の安全な移行（domain 先行作成 → collector 修正）

---

## ADR-016: Nurture ドメイン層確立 + Status Screen 本番化（Phase 2A）

| 項目 | 内容 |
|------|------|
| ステータス | 承認済 |
| 日付 | 2026-02-13 |
| 決定者 | Rebecca (PO) |

### コンテキスト

Phase 1.5 でドメインレイヤーの「背骨」を確立したが、以下が残課題だった:

1. `collect_nurture.py` に育成パラメータの全計算ロジック（~300行）が埋め込まれている
2. `collect_skills.py` にスキルレベル計算が埋め込まれている
3. `nurture.json` / `skills.json` に `schema_version` / `staleness` が未付与
4. `write_json_atomic` が各 collector に重複実装されている
5. `nurture-prototype.html` が外部 Google Fonts に依存し、プロジェクトルール違反

### 決定

**Phase 2A として以下を実施する:**

1. **`domain/nurture.py` 新設** — 育成パラメータ計算（energy, mood, trust, intimacy, EXP, level）を純粋関数として抽出
2. **`domain/skills.py` 新設** — スキルレベル計算・ラベル判定を純粋関数として抽出
3. **`domain/constants.py` 拡張** — Nurture 関連定数（閾値、重み、メッセージプール）を一元管理
4. **`domain/rebecca.py` 拡張** — mood 状態に基づく voice 変調（パーソナリティ層の実装）
5. **Collector 配線変更** — `collect_nurture.py` / `collect_skills.py` を I/O 専任に。`domain.schema.write_json_atomic` 統合、`inject_version` / `inject_staleness` 追加
6. **`nurture.html` 本番化** — プロトタイプからの移行: Google Fonts → システムフォントスタック、カラーパレット → Rebecca パレット統一、デモ機能除去

### 根拠

| 項目 | Before (Phase 1.5) | After (Phase 2A) |
|------|---------------------|-------------------|
| 育成ロジック | collect_nurture.py に ~300行混在 | domain/nurture.py（純粋関数14個） |
| スキルロジック | collect_skills.py に混在 | domain/skills.py（純粋関数2個） |
| write_json_atomic | 3箇所に重複 | domain.schema に一本化 |
| nurture/skills JSON | schema_version なし | schema_version + staleness 追加 |
| Status Screen | プロトタイプ（外部フォント依存） | 本番（システムフォント、Rebecca パレット） |
| パーソナリティ | スタブ | mood→voice 変調が動作 |
| テスト | 95件 | 201件（+106件） |

### 設計判断

- **システムフォントスタック**: `ui-monospace, 'SF Mono', Menlo, Monaco, Consolas, monospace` でサイバーパンク感を維持しつつ外部依存ゼロを達成
- **Rebecca パレット統一**: `--pk: #c87088`（Rebecca pink）、`--cy: #05d9e8`（HUD 固有アクセントとして維持）
- **後方互換**: `compose()` は `nurture_result=None` で Phase 1.5 の呼び出しと互換。JSON 出力は既存フィールド同一値 + 新フィールド追加のみ
- **Activity パネル**: Phase 2D スコープのため「Coming Soon」表示に留め、枠のみ維持

### 影響

- ✅ 201件のユニットテストで品質保証（既存95件 + 新規106件が全 PASS）
- ✅ Collectors の JSON 出力は後方互換
- ✅ 外部依存ゼロの原則を完全遵守（Google Fonts 除去）
- ✅ `write_json_atomic` の統一で保守性向上
- ✅ Ghost 理論の「注意」（訪問追跡）「自律性」（Nurture 成長）要素を実現
- 📋 Phase 2B 以降: Activity ログ、Watch 版、ビジュアル進化へ
