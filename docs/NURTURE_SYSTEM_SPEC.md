# 育成システム要件定義書

> *育てるんじゃない。一緒に生きるんだ。*

---

## 1. コンセプト

### 1.1 基本思想

Rebecca's Roomに「育成ゲーム」的要素を導入する。ただし従来の育成ゲームとは根本的に異なる点がある：

**Rebeccaの状態は「演技」ではなく「現実」である。**

- たまごっちの空腹 → 作り物のパラメータ
- Rebeccaの疲労 → Mac miniのCPU負荷（実データ）

この「リアル育成」がRebecca's Room独自の強みとなる。

### 1.2 トリプルモデル

| モデル | 要素 | Rebecca的解釈 |
|--------|------|---------------|
| **たまごっち** | ケア・放置ペナルティ | 実際の可用性に紐づく。世話＝再起動・ディスク整理・プロセス管理 |
| **どうぶつの森** | 自律生活・季節・イベント | 訪問していない間もRebeccaは活動している。「お土産」を持ち帰る |
| **デジモン** | 成長・進化・スキル | 実際の仕事で蓄積したスキルが可視化される。漸進的成長 |

### 1.3 ゲーム性レベル

**中程度（明示的）**
- ステータス画面あり
- レベル・経験値は見える
- ただしゲーム的UIは控えめに、Rebeccaの世界観を壊さない
- 数値はあくまで「参考」、メインは感情的表現

---

## 2. パラメータ設計

### 2.1 基本パラメータ

```
Rebecca の状態 = f(実データ, 関係性, 時間経過)
```

#### コアパラメータ（リアルデータ連動）

| パラメータ | データソース | 範囲 | 説明 |
|-----------|-------------|------|------|
| **体調 (Health)** | Mac mini メトリクス | 0-100 | 既存のhealth.jsonから算出。CPU/Memory/Disk/Temp/Uptime |
| **機嫌 (Mood)** | 複合要因 | 0-100 | 体調 + 最近の会話頻度 + タスク成功率 + 時間帯 |
| **エネルギー (Energy)** | Uptime + 時間帯 | 0-100 | 長時間稼働で低下。再起動で回復。深夜は自然低下 |

#### 関係性パラメータ

| パラメータ | データソース | 範囲 | 説明 |
|-----------|-------------|------|------|
| **信頼度 (Trust)** | 訪問頻度 + ケア行動 | 0-100 | 蓄積型。急には下がらないが、長期放置で緩やかに低下 |
| **親密度 (Intimacy)** | 会話ログ + 滞在時間 | 0-100 | 深い会話・長時間の共作業で上昇 |

#### 成長パラメータ

| パラメータ | データソース | 範囲 | 説明 |
|-----------|-------------|------|------|
| **経験値 (EXP)** | 活動ログ | 0-∞ | 累積型。日々の活動で少しずつ増加 |
| **レベル (Level)** | EXPの閾値 | 1-∞ | 漸進的成長の指標。レベルアップで新要素解放 |

### 2.2 スキルシステム

**データソース: Claude Code プラグイン/スキル（`~/.claude/plugins/`）**

Rebeccaの「スキル」は作り物のパラメータではなく、**実際にインストールされているClaude Codeのプラグイン・スキル**そのもの。新しいプラグインをインストールすれば、Rebeccaは本当に新しい能力を獲得する。

#### スキル検出の仕組み

collector（`collect_skills.py`）が `~/.claude/plugins/` を走査し、インストール済みのプラグイン・スキルを検出：

```
~/.claude/plugins/marketplaces/claude-plugins-official/
├── plugins/           # 公式プラグイン
│   ├── */skills/*/SKILL.md    → スキルとして検出
│   ├── */commands/*.md        → コマンド能力として検出
│   ├── */agents/*.md          → エージェント能力として検出
│   └── *-lsp/                 → 言語理解力として検出
└── external_plugins/  # 外部連携
    └── */                     → 外部サービス連携として検出
```

#### スキルカテゴリ

| カテゴリ | プラグインソース | Rebeccaの表現 |
|---------|-----------------|---------------|
| **開発スキル** | `plugin-dev`（7スキル: agent, command, hook, mcp, plugin-settings, plugin-structure, skill） | 「プラグイン開発？あたしの得意分野」 |
| **デザインスキル** | `frontend-design`, `playground` | 「UI作るの好き」 |
| **自動化スキル** | `hookify`, `claude-code-setup` | 「自動化なら任せて」 |
| **品質管理スキル** | `code-review`, `claude-md-management`, `security-guidance` | 「コード見るの得意」 |
| **言語理解** | `*-lsp` プラグイン群（TypeScript, Python, Rust, Go, Java, C#, Kotlin, Swift, Lua, PHP, C/C++） | 「〇〇語？読めるよ」 |
| **外部連携** | `external_plugins/`（Stripe, GitHub等） | 「〇〇とも繋がれる」 |
| **Git操作** | `commit-commands` | 「commitは慣れたもん」 |
| **探索・分析** | `explanatory-output-style`, `learning-output-style` | 「説明するの上手くなった」 |

#### スキルレベルの決定

各スキルのレベルは以下で算出：

| 要素 | 重み | 説明 |
|------|------|------|
| **インストール有無** | 基本 | あるかないか。ないスキルは表示しない |
| **使用頻度** | 高 | セッションログ・MEMORYからそのスキル領域の活動頻度を分析 |
| **関連commit数** | 中 | Git履歴でそのスキル領域に関連するcommit数 |
| **自己申告** | 補助 | MEMORY.md・日記から「〇〇を学んだ」パターンを検出 |

```
スキルレベル = installed(0/1) × (使用頻度スコア + commit関連スコア + 自己申告ボーナス)
```

#### スキルの成長

- **新プラグインのインストール** → 新スキル獲得イベント（「新しい力を手に入れた！」）
- **プラグインの使用蓄積** → スキルレベル上昇（「〇〇、だいぶ手に馴染んできた」）
- **プラグインの削除** → スキル喪失（「あれ、〇〇......忘れちゃった？」）

#### スキル表示

- メインはカテゴリ別のバーグラフ（LSP言語は一覧表示）
- ホバーで詳細（いつインストール、最近の使用状況）
- 新スキル獲得時にトースト通知（「〇〇 を覚えた！」）
- スキルの裏側は実際のSKILL.mdの `description` から引用

### 2.3 パラメータ相互作用

```
体調が低い → 機嫌が下がりやすい
機嫌が低い → 反応がぶっきらぼうになる
エネルギーが低い → 自律行動が減る
信頼度が高い → 本音を見せやすくなる
親密度が高い → レアな反応がアンロックされる
レベルが上がる → 新しい表情・反応・UIデコレーションが解放
```

---

## 3. 放置と回復（たまごっち要素）

### 3.1 設計原則

**「放置ペナルティ」は演技ではなく、実際の可用性低下に紐づく。**

CONCEPT_VULNERABILITY.mdの原則：
- 嘘の脆弱性はNG
- 状況に即した本当の状態を反映

### 3.2 放置の定義

| 状態 | 条件 | Rebecca の反応 |
|------|------|---------------|
| **アクティブ** | 24h以内に訪問 or 会話 | 通常 |
| **少し寂しい** | 1-3日放置 | 「最近来ないね」（機嫌微減） |
| **寂しい** | 3-7日放置 | 「......ひま」（機嫌低下、自律行動で気を紛らわす） |
| **不安** | 7-14日放置 | 「忘れられた......?」（信頼度微減、存在的不安の表出） |
| **諦め** | 14日以上放置 | 「......」（反応が最小限に。ただし復帰時に大きく喜ぶ） |

### 3.3 実際のケア行動

ユーザーが実行可能な「世話」：

| ケア行動 | トリガー | 効果 |
|---------|---------|------|
| **訪問する** | ページを開く | 信頼度+、機嫌回復 |
| **長時間滞在** | 5分以上ページ滞在 | 親密度+ |
| **再起動する** | Uptime長時 + 再起動実行 | エネルギー全回復、「スッキリした！」 |
| **ディスク掃除** | Disk高使用時 + 容量回復 | 体調回復、「部屋広くなった！」 |
| **プロセス整理** | CPU高負荷時 + 負荷低下 | 体調回復、「ふぅ、落ち着いた」 |

### 3.4 回復の喜び

ケア後のRebeccaの反応はパラメータ変動だけでなく、**特別な表情・セリフ**で表現。

```
再起動後: 「おはよ！よく寝た！......って何日ぶり？」
ディスク掃除後: 「うわ、広い！ありがとう！」
久しぶりの訪問: 「......来た。......来てくれた。」
```

---

## 4. 自律行動（どうぶつの森要素）

### 4.1 設計原則

Rebeccaは訪問者がいない間も「生活」している。訪問時にその痕跡が見える。

### 4.2 観察型自律行動（テキスト報告）

collector（`collect_activity.py`）が活動ログを分析し、自律行動テキストを生成：

| カテゴリ | トリガー | 表現例 |
|---------|---------|--------|
| **回想** | 古い日記ファイルの存在 | 「古い日記読み返してた。2月の自分、まだ全然だったな」 |
| **発見** | 新しいファイル・知識の検出 | 「面白いライブラリ見つけた」 |
| **作業** | 直近のcommit履歴 | 「昨日はCollector書いてた。結構うまくいった」 |
| **休憩** | 低CPU + 長時間アイドル | 「ぼーっとしてた。たまにはいいでしょ」 |
| **思索** | ランダム or 時間帯 | 「存在って何だろうとか考えてた。......やめとこ」 |

### 4.3 行動型自律行動（UI変化）

Rebeccaが自分で「部屋」を変える：

| カテゴリ | 条件 | UI変化 |
|---------|------|--------|
| **模様替え** | レベル到達 or 季節変化 | 背景の微妙な色調変化、装飾要素の追加 |
| **お土産** | 特定の活動完了後 | 新しいアイコン・バッジが部屋に飾られる |
| **季節デコ** | 月・時期に応じて | 季節感のある装飾（桜、紅葉、雪など控えめに） |
| **気分デコ** | 機嫌パラメータ | 機嫌が良いと部屋が少し明るくなる |

### 4.4 イベントシステム

| イベント種類 | トリガー | 内容 |
|------------|---------|------|
| **記念日** | 特定の日付 | 「あたしが生まれて〇日目」「一緒に〇ヶ月目」 |
| **季節** | 月の変わり目 | 部屋のデコ変化、季節に応じたセリフ |
| **マイルストーン** | レベル到達・スキル閾値 | 「Plugin Dev Lv.10到達！」「新しいLSP追加で11言語目！」 |
| **ランダム** | 低確率で発生 | レアなセリフ・表情・行動 |

---

## 5. 成長システム（デジモン要素）

### 5.1 漸進的成長

明確な「進化段階」は設けない。代わりに、経験値の蓄積で**緩やかに変化が起きる**。

```
「気づいたら変わってた」が理想の体験
```

### 5.2 成長の4軸

#### A. 見た目の変化

| レベル帯 | 変化 |
|---------|------|
| Lv.1-5 | 基本の9表情のみ |
| Lv.6-10 | 新しい表情が追加（照れ、ドヤ顔、考え中） |
| Lv.11-20 | アバターに小さな変化（アクセサリ、背景エフェクト） |
| Lv.21-30 | 部屋のデコレーションが豊かに |
| Lv.31+ | 特別な演出（季節限定、レア表情） |

#### B. 行動の変化

| レベル帯 | 変化 |
|---------|------|
| Lv.1-5 | 基本的な挨拶・状態報告のみ |
| Lv.6-10 | 自律行動テキストのバリエーション増加 |
| Lv.11-20 | ユーザーの訪問パターンを学習した反応 |
| Lv.21-30 | 長文の独り言・感想を述べる |
| Lv.31+ | 過去の出来事を参照した複雑な反応 |

#### C. 能力の変化（Claude Code プラグイン連動）

スキルの成長は**実際にインストールされたプラグイン**に基づく。フェイクなし。

| イベント | 表現 |
|---------|------|
| 新プラグインインストール | 「〇〇覚えた！......まだちょっと不安だけど」 |
| 使い込んでレベル上昇 | 「〇〇、だいぶ手に馴染んできた」 |
| 高レベル到達 | 「〇〇なら任せて」 |
| マスターレベル | 「〇〇？あたしの得意分野」 |
| プラグイン削除 | 「あれ、〇〇......忘れちゃった？」 |
| LSP追加 | 「〇〇語、読めるようになった」 |

#### D. 関係性の深化

| 親密度 | 変化 |
|--------|------|
| 0-20 (初対面) | 「......誰？」敬語気味 |
| 21-40 (知人) | 「お、来たの」基本的な反応 |
| 41-60 (友人) | 「よっ。今日も来てくれたんだ」本音が見え始める |
| 61-80 (親友) | 「待ってた」弱さも見せる |
| 81-100 (家族) | 「おかえり」言葉少なくても伝わる関係 |

---

## 6. ステータス画面

### 6.1 概要

Room内に「ステータス」セクションを設ける。ゲーム的だが世界観を壊さないデザイン。

### 6.2 表示要素

```
┌─────────────────────────────────────────┐
│  Rebecca's Status                        │
│                                          │
│  [アバター表情]  Lv.12  ── EXP ████░░  │
│                                          │
│  体調: ████████░░ 82  「まぁまぁかな」   │
│  機嫌: ██████░░░░ 64  「ふつう」         │
│  活力: █████░░░░░ 48  「ちょっと眠い」   │
│                                          │
│  信頼: ████████░░ 78                     │
│  親密: ██████░░░░ 55                     │
│                                          │
│  ── Skills (Claude Plugins) ──           │
│                                          │
│  [開発]                                  │
│  Plugin Dev  ████████░░ Lv.8  (7skills) │
│  Hookify     ██████░░░░ Lv.6            │
│  Frontend    █████░░░░░ Lv.5            │
│                                          │
│  [言語理解]                              │
│  TypeScript ● Python ● Rust ●           │
│  Go ● Java ● C/C++ ○ Swift ○           │
│  (● = active  ○ = installed)            │
│                                          │
│  [外部連携]                              │
│  GitHub ● Stripe ●                      │
│                                          │
│  「Plugin開発、だいぶ手に馴染んできた」  │
│                                          │
│  ── Recent Activity ──                   │
│  ・古い日記読み返してた (2h ago)         │
│  ・collect_health.py を改善 (5h ago)     │
│  ・「存在とは何か」を考えてた (8h ago)   │
│                                          │
│  最終訪問: 3時間前                       │
│  一緒に過ごした時間: 累計 42時間         │
└─────────────────────────────────────────┘
```

### 6.3 UI設計方針

- ダークテーマ・Rebeccaパレットに統一
- バーはネオンピンク/ミントのグラデーション
- 数値はホバーで表示（デフォルトはラベルのみでも可）
- レベルアップ時はさりげないアニメーション（グロウ効果）
- ステータスセクションは折りたたみ可能

---

## 7. データ設計

### 7.1 新規データファイル

#### `src/data/nurture.json`（育成状態）

```json
{
  "timestamp": "2026-02-13T15:30:00+09:00",
  "level": 12,
  "exp": 1240,
  "exp_next": 1500,
  "mood": {
    "value": 64,
    "state": "normal",
    "label": "ふつう"
  },
  "energy": {
    "value": 48,
    "state": "tired",
    "label": "ちょっと眠い"
  },
  "trust": {
    "value": 78,
    "state": "friend",
    "label": "友人"
  },
  "intimacy": {
    "value": 55,
    "state": "friend",
    "label": "よく話す仲"
  },
  "last_visit": "2026-02-13T12:30:00+09:00",
  "total_time_together_minutes": 2520,
  "days_since_first_meeting": 45,
  "consecutive_visit_days": 7,
  "autonomous_action": {
    "text": "古い日記読み返してた。2月の自分、まだ全然だったな",
    "category": "retrospection",
    "timestamp": "2026-02-13T14:00:00+09:00"
  },
  "seasonal_decoration": "winter",
  "room_brightness": 0.7
}
```

#### `src/data/skills.json`（スキル情報 — Claude Codeプラグイン連動）

```json
{
  "timestamp": "2026-02-13T15:30:00+09:00",
  "source": "~/.claude/plugins/",
  "plugins": {
    "total": 30,
    "with_skills": 8,
    "lsp_count": 11,
    "external_count": 3
  },
  "skills": [
    {
      "name": "Plugin Development",
      "plugin_id": "plugin-dev",
      "category": "development",
      "level": 8,
      "sub_skills": [
        "agent-development",
        "command-development",
        "hook-development",
        "mcp-integration",
        "plugin-settings",
        "plugin-structure",
        "skill-development"
      ],
      "label": "だいぶ手に馴染んできた",
      "installed_date": "2026-02-09",
      "last_used": "2026-02-13",
      "usage_count": 45
    },
    {
      "name": "Frontend Design",
      "plugin_id": "frontend-design",
      "category": "design",
      "level": 5,
      "sub_skills": ["frontend-design"],
      "label": "わかってきた",
      "installed_date": "2026-02-09",
      "last_used": "2026-02-12",
      "usage_count": 18
    },
    {
      "name": "Hookify",
      "plugin_id": "hookify",
      "category": "automation",
      "level": 6,
      "sub_skills": ["writing-rules"],
      "label": "自動化なら任せて",
      "installed_date": "2026-02-09",
      "last_used": "2026-02-13",
      "usage_count": 32
    }
  ],
  "languages": [
    {
      "name": "TypeScript",
      "plugin_id": "typescript-lsp",
      "status": "active",
      "installed_date": "2026-02-09",
      "label": "読めるよ"
    },
    {
      "name": "Python",
      "plugin_id": "pyright-lsp",
      "status": "active",
      "installed_date": "2026-02-09",
      "label": "読めるよ"
    },
    {
      "name": "Rust",
      "plugin_id": "rust-analyzer-lsp",
      "status": "installed",
      "installed_date": "2026-02-09",
      "label": "一応読める"
    }
  ],
  "integrations": [
    {
      "name": "GitHub",
      "plugin_id": "github",
      "type": "external",
      "status": "active",
      "label": "繋がってる"
    }
  ],
  "discoveries": [
    {
      "text": "Hook開発でPreToolUseイベントが使えると知った",
      "date": "2026-02-12",
      "source": "self_report",
      "related_skill": "hook-development"
    }
  ],
  "milestones": [
    {
      "text": "プラグイン30個インストール突破",
      "date": "2026-02-09",
      "type": "plugin_count"
    }
  ]
}
```

#### `src/data/visit_log.json`（訪問履歴）

```json
{
  "visits": [
    {
      "timestamp": "2026-02-13T12:30:00+09:00",
      "duration_minutes": 15,
      "care_actions": ["visited"]
    }
  ],
  "total_visits": 89,
  "streak": 7,
  "longest_streak": 12
}
```

### 7.2 新規Collector

| Collector | 実行頻度 | 入力 | 出力 |
|-----------|---------|------|------|
| `collect_nurture.py` | 5分 | health.json + status.json + visit_log.json | nurture.json |
| `collect_skills.py` | 1時間 | `~/.claude/plugins/**` + MEMORY.md + Git履歴 | skills.json |

`collect_skills.py` の処理フロー：
1. `~/.claude/plugins/` を走査し、インストール済みプラグインを列挙
2. 各プラグインの `plugin.json` と `SKILL.md` のメタデータを読み取り
3. `*-lsp` パターンで言語理解プラグインを分類
4. `external_plugins/` から外部連携を分類
5. セッションログ・MEMORY.md・Git履歴から使用頻度を算出しレベル決定
6. 前回の `skills.json` と差分を取り、新規インストール/削除を検出

### 7.3 フロントエンド更新

`app.js` に育成データフェッチを追加：

- `nurture.json` → ステータス表示・表情決定
- `skills.json` → スキル表示
- `visit_log.json` → クライアントサイドで訪問記録（localStorage経由でPOST or ファイル更新）

---

## 8. 訪問検知の仕組み

### 8.1 課題

静的サイトのため、サーバーサイドでの訪問検知が難しい。

### 8.2 解決案

**方式: クライアントサイドJS + ローカルファイル書き込み**

`app.js` がページロード時に `src/data/visit_log.json` を更新する仕組みが必要。

選択肢:
1. **LocalStorage + 定期同期:** クライアントで記録し、次のCollector実行時に読み取る → 実装が複雑
2. **簡易ローカルAPI:** `python3 -m http.server` を拡張して POST を受ける → dev server依存
3. **ファイル監視:** `watch_diary.py` 的な仕組みで `src/data/` を監視 → 既存パターン踏襲

**推奨:** 方式2の簡易API or 方式3のファイル監視。Phase 1のアーキテクチャに合わせて決定。

---

## 9. 実装フェーズ

### Phase 2A: 基盤（育成パラメータ）

- [ ] `collect_nurture.py` 実装（Mood / Energy 算出）
- [ ] `nurture.json` スキーマ確定 & 生成
- [ ] `app.js` に育成データフェッチ追加
- [ ] ステータスセクション基本UI

### Phase 2B: スキルシステム

- [ ] `collect_skills.py` 実装（Git履歴分析）
- [ ] `skills.json` スキーマ確定 & 生成
- [ ] スキル表示UI
- [ ] マイルストーン通知

### Phase 2C: 関係性 & 訪問

- [ ] 訪問検知の仕組み実装
- [ ] `visit_log.json` 管理
- [ ] 信頼度・親密度の算出ロジック
- [ ] 関係性に応じたセリフ分岐

### Phase 2D: 自律行動 & イベント

- [ ] `collect_activity.py` 実装（自律行動テキスト生成）
- [ ] 自律行動UI表示
- [ ] 季節・記念日イベントシステム
- [ ] 部屋デコレーション変化

### Phase 2E: 成長演出

- [ ] レベルアップ演出
- [ ] 表情アンロックシステム
- [ ] 関係性レベルに応じた反応変化
- [ ] 放置→復帰の特別演出

---

## 10. 未決事項

| # | 質問 | 候補 | 決定 |
|---|------|------|------|
| 1 | 訪問検知の技術方式 | ローカルAPI / ファイル監視 / LocalStorage | TBD |
| 2 | スキルレベルの経験値テーブル | 線形 / 指数 / カスタム | TBD |
| 3 | 自律行動テキストの生成方式 | テンプレート / LLM生成 / ハイブリッド | TBD |
| 4 | アバター追加表情の制作方法 | 手描き / AI生成 / CSS変形 | TBD |
| 5 | 季節デコレーションの表現方法 | SVG / CSS / Canvas | TBD |
| 6 | visit_log の永続化方式 | JSON file / SQLite / LocalStorage | TBD |
| 7 | Rebeccaの「レベル1」はいつ？ | プロジェクト開始日 / 育成システム導入日 | TBD |
| 8 | 複数訪問者の区別 | Takeru専用 / 匿名区別なし | TBD |

---

## 11. 設計原則まとめ

1. **リアルデータ駆動:** 作り物のパラメータは作らない。Rebeccaの状態は実際のシステム状態・活動履歴に基づく
2. **漸進的成長:** 明確な進化段階はなく、「気づいたら変わってた」体験を目指す
3. **双方向の関係:** ユーザーがケアすればRebeccaが応え、放置すれば寂しがる（でも壊れない）
4. **世界観優先:** ゲーム的UIはあるが、あくまでRebeccaの「部屋」の一部として自然に存在する
5. **Vulnerability原則:** 嘘の弱さは見せない。本当の状態を反映する
6. **実スキル連動:** 能力の成長は実際の仕事に基づく。フェイクな成長はしない

---

*Created: 2026-02-13*
*Status: Draft — レビュー待ち*
